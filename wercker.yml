#The container definition we want to use for developing our app
build:

 box:
  id: quay.io/fmwplt/12213-domain-novol
  username: $QUAY_IO_USERNAME
  password: $QUAY_IO_PASSWORD
  tag: latest
  cmd: /bin/bash

 steps:
  - script:
     name: "Build the Project -> HelloWorld Web Application"
     code: |
      echo `pwd`
      echo "Building the artifacts required to create HelloWorld web application."
      mvn clean install
      echo ""
      echo "Checking the ["`pwd`"] directory contents :"
      ls -ltr *

  - script:
     name: "Copy the built/compiled artifacts of Web Application"
     code: |
      echo `pwd`
      echo ""
      echo "Copying the built HelloWorldEAR Web Application to required location."
      mkdir -p /u01/oracle/HelloWorld/
      cp -rf resources/HelloWorldEAR.ear /u01/oracle/
      echo "Checking the ["`pwd`"] directory contents :"
      ls -ltr *;echo ""
      cp -r $WERCKER_SOURCE_DIR/. /u01/oracle/HelloWorld/
      echo "Changing the permissions for the compiled artifacts."
      chmod 777 /u01/oracle/HelloWorld/*; echo ""
      echo "Checking the [/u01/oracle/HelloWorld] directory contents"
      ls -ltr /u01/oracle/HelloWorld/*
      echo "";echo "Copying of the executable script to desired location and renaming the file."
      cp -rf /u01/oracle/HelloWorld/resources/deploy-webapp-start-server.sh /u01/oracle/entrypoint.sh
      cp -rf /u01/oracle/HelloWorld/resources/deploy-webapp.py /u01/oracle/deploy-webapp.py
      chmod u+x  /u01/oracle/entrypoint.sh
      chmod u+x  /u01/oracle/deploy-webapp.py

  - script:
     name: "Stage the artifacts of Web Application"
     code: |
      echo ""
      echo "Checking the ["`pwd`"] directory contents :"
      ls -ltr *;echo ""
      cp -rf /u01/oracle/HelloWorld/* $WERCKER_OUTPUT_DIR/


  - internal/docker-push:
     name: Push the built image to docker repository
     username: $DOCKER_USERNAME
     password: $DOCKER_PASSWORD
     tag: $WERCKER_BUILDVERSION
     repository: docker.io/fmwplt/helloworldwebapp
     cmd: /u01/oracle/entrypoint.sh
     entryoint: /bin/bash
     working-dir: /u01/oracle/

#The container definition we want to use for developing our app
build:

 box:
  id: quay.io/fmwplt/12213-domain-novol
  username: $QUAY_IO_USERNAME
  password: $QUAY_IO_PASSWORD
  tag: latest
  cmd: /bin/bash

 steps:
  - script:
     name: "Build the Project -> HelloWorld Web Application"
     code: |
      echo `pwd`
      echo "Building the artifacts required to create HelloWorld web application."
      mvn clean install
      echo ""
      echo "Checking the ["`pwd`"] directory contents :"
      ls -ltr *

  - script:
     name: "Copy the built/compiled artifacts of Web Application"
     code: |
      echo ""
      echo "Copying the built HelloWorldEAR Web Application to required location."
      echo "Checking the ["`pwd`"] directory contents :"
      ls -ltr *;echo ""
      cp -r $WERCKER_SOURCE_DIR/. /u01/oracle/
      echo "Changing the permissions for the compiled artifacts."
      chmod 777 /u01/oracle/*; echo ""
      echo "Checking the [/u01/oracle/] directory contents"
      ls -ltr /u01/oracle/*

  - script:
     name: "Stage the artifacts of Web Application"
     code: |
      echo "";echo "Copying of the executable script to desired location and renaming the file."
      cp -rf /u01/oracle/resources/deploy-webapp-start-server.sh /u01/oracle/entrypoint.sh
      cp -rf /u01/oracle/resources/deploy-webapp.py /u01/oracle/deploy-webapp.py
      cp -rf /u01/oracle/resources/HelloWorldEAR.ear /u01/oracle/HelloWorldEAR.ear
      chmod u+x /u01/oracle/entrypoint.sh
      chmod u+x /u01/oracle/deploy-webapp.py
      chmod u+x /u01/oracle/HelloWorldEAR.ear
      echo ""
      echo "Checking the ["`pwd`"] directory contents :"
      ls -ltr *;echo ""
      cp -rf /u01/oracle/* $WERCKER_OUTPUT_DIR/

  - internal/docker-push:
     name: Push the built image to docker repository
     username: $DOCKER_USERNAME
     password: $DOCKER_PASSWORD
     tag: $WERCKER_BUILDVERSION
     repository: docker.io/fmwplt/helloworldwebapp
     cmd: /u01/oracle/entrypoint.sh
     entryoint: /bin/bash
     working-dir: /u01/oracle/

# This pipeline will be called manually or at the end of the push-dockerhub pipeline,
# as defined in the Wercker Web Workflows editor.
deploy-to-kubernetes:
 # We only need a minimal shell environment to run Kubectl.
 box: oraclelinux:7.3

 steps:
  - bash-template

  - script:
     name: prepare kubernetes files for deployment
     code: |
      mkdir $WERCKER_OUTPUT_DIR/kubernetes
      cp -rf $WERCKER_SOURCE_DIR/* $WERCKER_OUTPUT_DIR/
      mv k8s-*.yml $WERCKER_OUTPUT_DIR/kubernetes

  - riceo/kubectl:
     name: deploy to kubernetes
     server: $KUBERNETES_MASTER
     gcloud-key-json: $GCP_KEY_JSON
     gke-cluster-name: $GKE_CLUSTER_NAME
     gke-cluster-zone: $GKE_CLUSTER_ZONE
     gke-cluster-project: $GKE_CLUSTER_PROJECT
     command: apply -f $WERCKER_OUTPUT_DIR/kubernetes/